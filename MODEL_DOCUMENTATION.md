# תיעוד מודל ניהול פרויקטי תשתיות

## סקירת המודל

מימוש זה יוצר מודל אופטימיזציה לניהול מספר פרויקטי תשתית במקביל תוך טיפול בהחלטות בחירת ספקים ותזמון. המודל מבוסס על הניסוח המתמטי המתואר בקובץ Model 1.docx.

## המודל המתמטי

### אינדקסים וקבוצות

- **פרויקטים (j)**: שלושה פרויקטי תשתית שיש להשלים
- **פעילויות (i)**: 23 פעילויות לכל פרויקט עם יחסי קדימות
- **חומרי גלם (k)**: ארבעה סוגים של חומרי גלם הנדרשים לפרויקטים
- **ספקים (s)**: ארבעה ספקים עם קיבולות וזמני אספקה שונים
- **זמן (t)**: תקופות זמן במודל

### משתני החלטה

- **ST[i][j]**: זמן התחלה של פעילות i בפרויקט j
- **FT[i][j]**: זמן סיום של פעילות i בפרויקט j
- **x[i][j][t]**: משתנה בינארי (1 אם פעילות i של פרויקט j מתחילה בזמן t, 0 אחרת)
- **TD[j]**: עיכוב (איחור) של פרויקט j ביחס לתאריך היעד
- **I[k][t]**: רמת מלאי של חומר גלם k בזמן t
- **O[k][s][i][j][t]**: כמות חומר גלם k שהוזמנה מספק s עבור פעילות i של פרויקט j בזמן t
- **y[k][s][i][j][t]**: משתנה בינארי (1 אם חומר גלם k הוזמן מספק s לפעילות i של פרויקט j בזמן t, 0 אחרת)
- **z[k][i][j][t]**: משתנה בינארי (1 אם חומר גלם k נדרש לפעילות i של פרויקט j בזמן t, 0 אחרת)
- **w[k][s][i][j]**: משתנה בינארי (1 אם חומר גלם k עבור פעילות i של פרויקט j מוקצה לספק s, 0 אחרת)
- **v[k][i][j]**: כמות חומר גלם k שנעשה בה שימוש בפועל על-ידי פעילות i של פרויקט j
- **Cmax**: זמן סיום מקסימלי של כל הפרויקטים (makespan)

### פונקציית מטרה

פונקציית המטרה ממזערת את עלויות הקנס הכוללות עקב עיכובים בפרויקט:

```
min ∑(Penalty[j] * TD[j]) לכל j
```

### אילוצים במודל (כל 24 האילוצים)

#### אילוץ 1: קשר בין משתנה בינארי x_ijt לזמן התחלה ST_ij
זמן התחלת הפעילות מחושב באמצעות משתנה בינארי:
```
ST[i][j] = ∑(t * x[i][j][t]) לכל i, j
```

#### אילוץ 2: פעילות מתחילה בדיוק פעם אחת
כל פעילות חייבת להתחיל בדיוק ברגע אחד:
```
∑(x[i][j][t]) = 1 לכל i, j
```

#### אילוץ 3: משך פעילות
זמן הסיום של פעילות שווה לזמן ההתחלה בתוספת משך הפעילות:
```
FT[i][j] = ST[i][j] + Duration[i][j] לכל i, j
```

#### אילוץ 4: יחסי קדימות
פעילות לא יכולה להתחיל לפני שהפעילות הקודמת לה הסתיימה:
```
ST[b][j] ≥ FT[a][j] לכל (a,b) ביחסי קדימות, לכל j
```

#### אילוץ 5: הגדרת זמן סיום מקסימלי (Cmax)
זמן הסיום המקסימלי של כל הפרויקטים:
```
Cmax ≥ FT[last_activity][j] לכל j
```

#### אילוץ 6: חישוב עיכוב בפרויקט
עיכוב בפרויקט מחושב כהפרש בין זמן הסיום לתאריך היעד:
```
TD[j] ≥ FT[last_activity][j] - Target[j] לכל j
TD[j] ≥ 0 לכל j
```

#### אילוץ 7: מאזן מלאי
עדכון רמת המלאי בכל תקופת זמן:
```
I[k][0] = initial_inventory לכל k
I[k][t] = I[k][t-1] + הזמנות שהגיעו - חומרים שנדרשו לפעילויות, לכל k, t > 0
```

#### אילוץ 8: קשר בין דרישת חומרים לפעילויות
דרישת חומרים מתואמת עם תחילת פעילויות:
```
z[k][i][j][t] = x[i][j][t] לכל k, i, j, t
```

#### אילוץ 9: מלאי לא שלילי
רמת המלאי לא יכולה להיות שלילית:
```
I[k][t] ≥ 0 לכל k, t
```

#### אילוץ 10: קשר בין משתנה בינארי y לכמות הזמנה O
הזמנה יכולה להיות חיובית רק אם משתנה הבינארי המתאים הוא 1:
```
O[k][s][i][j][t] ≤ M * y[k][s][i][j][t] לכל k, s, i, j, t
```

#### אילוץ 11: קיבולת ספקים
סך ההזמנות מספק לא יכול לעלות על הקיבולת שלו:
```
∑(O[k][s][i][j][t]) ≤ Capacity[k][s] לכל k, s, t
```

#### אילוץ 12: קשר בין משתני w ו-y
הקצאת ספקים לחומרים:
```
w[k][s][i][j] ≥ ∑(y[k][s][i][j][t]) / max_time לכל k, s, i, j
y[k][s][i][j][t] ≤ w[k][s][i][j] לכל k, s, i, j, t
```

#### אילוץ 13: הגבלת ספק יחיד לכל שילוב פעילות-חומר
כל שילוב של פעילות וחומר יכול להיות מוקצה לכל היותר לספק אחד:
```
∑(w[k][s][i][j]) ≤ 1 לכל k, i, j, כאשר UR[i][k] > 0
```

#### אילוץ 14: כמות חומר גלם בשימוש
כמות חומר הגלם בשימוש חייבת להתאים לכמות הנדרשת:
```
v[k][i][j] = UR[i][k] * Quantity[k][j] לכל k, i, j
```

#### אילוץ 15: התאמת כמות הזמנה לכמות בשימוש
סך כמות ההזמנות חייב להיות שווה לכמות בשימוש בפועל:
```
∑(O[k][s][i][j][t]) = v[k][i][j] לכל k, i, j, לכל s, t
```

#### אילוץ 16: חומרים חייבים להיות מוזמנים בחלון זמן ספציפי
הזמנת חומרים עם זמני אספקה:
```
t + Delivery_Time[k][s][j] ≤ ST[i][j] + M * (1 - y[k][s][i][j][t]) לכל k, s, i, j, t
```

#### אילוץ 17: מגבלות ניצול משאבים לפעילויות
הגבלת מספר פעילויות מקבילות מאותו סוג:
```
∑(x[i][j][t-d]) ≤ MAX_parallel_activities לכל i, t, לכל j, d
```

#### אילוץ 18: מניעת הזמנות מוקדמות שלא לצורך
אין להזמין חומרים מוקדם מדי:
```
y[k][s][i][j][t] = 0 לכל k, s, i, j כאשר t < earliest_time
```

#### אילוץ 19: זמינות חומרים למשך כל תקופת הפעילות
חומרים חייבים להיות זמינים לפני תחילת הפעילות:
```
∑(O[k][s][i][j][τ]) ≥ v[k][i][j] - M * (1 - x[i][j][t]) לכל k, i, j, t, לכל s, τ < t
```

#### אילוץ 20: מגבלות זמן סיום פרויקט
זמן סיום הפרויקט לא יכול לחרוג מהמשך המקסימלי המותר:
```
FT[last_activity][j] ≤ max_project_duration לכל j
```

#### אילוץ 21: מגבלות איכות ספקים
שימוש רק בספקים בעלי דירוג איכות מינימלי:
```
w[k][s][i][j] = 0 לכל k, s, i, j כאשר SupplierQuality[s] < MinQualityRequired
```

#### אילוץ 22: מגבלות תקציב
העלות הכוללת אינה יכולה לחרוג מהתקציב:
```
∑(Cost[k][s][j] * O[k][s][i][j][t]) ≤ TotalBudget לכל k, s, i, j, t
```

#### אילוץ 23: מגבלות הובלה
מזעור מרחק מספקים:
```
∑(SupplierDistance[s] * w[k][s][i][j]) ≤ MaxAllowedDistance * ∑(w[k][s][i][j]) לכל k, i, j, לכל s
```

#### אילוץ 24: מגבלות סביבתיות
הגבלת טביעת רגל פחמנית:
```
∑(SupplierCarbonFootprint[s] * O[k][s][i][j][t]) ≤ MaxCarbonFootprint לכל k, s, i, j, t
```

## נתוני קלט

### פרויקטים ופעילויות

- שלושה פרויקטי תשתית במקביל
- כל פרויקט כולל 23 פעילויות עם יחסי קדימות
- לפעילויות משכי זמן שונים עבור כל פרויקט

### חומרי גלם וספקים

- ארבעה סוגי חומרי גלם נדרשים לפרויקטים
- ארבעה ספקים עם קיבולות שונות לכל חומר
- לספקים זמני אספקה ועלויות שונות

### תאריכי יעד וקנסות

- לכל פרויקט תאריך יעד להשלמה
- קנסות מוטלים עבור כל יום של עיכוב מעבר לתאריך היעד

### פרמטרים חדשים למגבלות הנוספות

- מספר מקסימלי של פעילויות מקבילות מאותו סוג: 2
- חלון זמן מוקדם ביותר להזמנת חומרים: 15 ימים
- משך מקסימלי מותר לפרויקט: 450 ימים
- איכות ספקים ודרישת איכות מינימלית: 70 (מתוך 100)
- תקציב כולל מקסימלי: 500,000 ש״ח
- מרחק מקסימלי מותר מספקים: 180 ק״מ
- סף מקסימלי מותר של טביעת רגל פחמנית: 400,000 יחידות CO2

## מימוש

המימוש מורכב מהקבצים הבאים:

1. **model_data.py**: מכיל את המחלקה `ModelData` עם כל פרמטרי הקלט
2. **model1.py**: מיישם את מודל האופטימיזציה באמצעות ספריית Python-MIP
3. **utils.py**: מכיל פונקציות עזר ליצירת ויזואליזציות
4. **main.py**: סקריפט ראשי שמריץ את המודל ומייצר דוחות וויזואליזציות

## הרצת המודל

להרצת המודל, הפעל את הפקודה הבאה:

```bash
python main.py
```

הסקריפט יבצע:
1. טעינת נתוני המודל
2. יצירה ופתרון של מודל האופטימיזציה
3. יצירת דוחות מפורטים
4. יצירת ויזואליזציות של התוצאות

## פלט וויזואליזציות

המודל מייצר את הפלטים הבאים:

### דוחות

1. **דוח השלמת פרויקט**: מציג תאריכי יעד, זמני השלמה בפועל, עיכובים וקנסות לכל פרויקט
2. **דוח לוח זמנים לפעילויות**: מציג את זמני ההתחלה והסיום לכל פעילות בכל פרויקט
3. **דוח הקצאת ספקים**: מציג כיצד חומרים מוקצים מספקים לפרויקטים
4. **דוח דרישות משאבים**: מציג את הכמויות הנדרשות והמוקצות של חומרים לכל פרויקט

### ויזואליזציות

1. **תרשים גאנט**: ייצוג חזותי של לוח הזמנים לפרויקט, המציג מתי כל פעילות מתחילה ומסתיימת
2. **תרשים שימוש במשאבים**: מפת חום המציגה את השימוש בחומרי גלם לפי פרויקט
3. **תרשים עיכובי פרויקט**: השוואה בין תאריכי יעד לזמני השלמה בפועל, יחד עם עיכובים וקנסות
4. **תרשים הקצאת ספקים**: מציג כיצד חומרי גלם מוקצים מספקים לפרויקטים
5. **תרשים נתיב קריטי**: מדגיש את הפעילויות הקריטיות בכל פרויקט

## הבדלים בין המודל המקורי בקובץ Model 1.docx למימוש בקוד

המימוש בקוד מתבסס על המודל המתמטי, אך כולל התאמות מסוימות:

1. **הגדרת אופק זמן**: המודל מגדיר אופק זמן אוטומטי בהתבסס על סך משכי הפעילויות, עם מגבלה של 100 ימים לשיפור יכולת הפתרון
2. **פישוט אילוצי מלאי**: פישוט חלק מהאילוצים המורכבים למען משך זמן פתרון סביר 
3. **ליניאריזציה**: שינוי אילוצים מסוימים כדי להימנע מהכפלה ישירה של משתני החלטה

## מגבלות והנחות המודל

1. המודל מניח משכי זמן דטרמיניסטיים לפעילויות וזמני אספקה
2. המודל מגביל את מספר הפעילויות המקבילות מאותו סוג
3. המודל מניח שכל החומרים חייבים להיות מוזמנים ומסופקים לפני תחילת הפעילויות
4. בשל מורכבות המודל, זמן פתרון ארוך יכול להידרש, או שלא תימצא פתרון אופטימלי

## שיפורים עתידיים

1. **משכי זמן סטוכסטיים**: הוספת אי-ודאות במשכי פעילות וזמני אספקת חומרים
2. **איזון משאבים**: שיפור נוסף של אילוצי הגבלת פעילויות מקבילות
3. **אספקות חלקיות**: מתן אפשרות לאספקת חומרים במשלוחים חלקיים
4. **אופטימיזציה מחדש דינמית**: יישום מסגרת לעדכון המודל תוך כדי התקדמות הפרויקטים
5. **שיפור ביצועים**: הפחתת זמן הפתרון באמצעות טכניקות פתרון היוריסטיות או דקומפוזיציה

## סיכום

מימוש זה מספק פתרון מקיף לניהול מספר פרויקטי תשתית עם בחירת ספקים, המתבסס על המודל המתמטי המקורי בקובץ Model 1.docx. המודל מיישם את כל 24 האילוצים, ומספק יכולות לתזמון פעילויות, ניהול מלאי, והקצאת משאבים.

המודל ממזער את עלויות הקנסות עקב עיכובים תוך התחשבות בקיבולות ספקים, דרישות חומרים, יחסי קדימות בין פעילויות, וגם אילוצי תקציב ואיכות, ובכך מאפשר למנהלי פרויקטים לתאם מספר פרויקטים בו-זמנית ולקבל החלטות מושכלות לגבי בחירת ספקים ותזמון.
